--- massdns-1.1.0/src/random.h	2024-03-09 08:33:40.000000000 +0800
+++ massdns-1.1.0/src/random.h	2025-04-23 20:59:44.821936220 +0800
@@ -5,6 +5,19 @@
 
 #include <stdio.h>
 #include <stdbool.h>
+#include <stdint.h>
+#include <stdlib.h>
+#include <string.h>
+#include <time.h>
+#include <unistd.h>
+
+// 判断是否支持 __uint128_t
+#if defined(__SIZEOF_INT128__)
+    typedef __uint128_t u128;
+    #define HAS_UINT128 1
+#else
+    #define HAS_UINT128 0
+#endif
 
 static FILE *randomness;
 
@@ -15,12 +28,23 @@
 
 static inline uint64_t wyhash64_stateless(uint64_t *seed) {
     *seed += UINT64_C(0x60bee2bee120fc15);
-    __uint128_t tmp;
-    tmp = (__uint128_t)*seed * UINT64_C(0xa3b195354a39b70d);
-    uint64_t m1 = (tmp >> 64) ^ tmp;
-    tmp = (__uint128_t)m1 * UINT64_C(0x1b03738712fad5c9);
-    uint64_t m2 = (tmp >> 64) ^ tmp;
+#if HAS_UINT128
+    u128 tmp;
+    tmp = (u128)(*seed) * UINT64_C(0xa3b195354a39b70d);
+    uint64_t m1 = (uint64_t)((tmp >> 64) ^ tmp);
+    tmp = (u128)m1 * UINT64_C(0x1b03738712fad5c9);
+    uint64_t m2 = (uint64_t)((tmp >> 64) ^ tmp);
     return m2;
+#else
+    // 简化替代逻辑：用两个乘法和移位模拟（较弱的散列）
+    uint64_t x = *seed;
+    x ^= (x >> 30);
+    x *= UINT64_C(0xa3b195354a39b70d);
+    x ^= (x >> 27);
+    x *= UINT64_C(0x1b03738712fad5c9);
+    x ^= (x >> 31);
+    return x;
+#endif
 }
 
 // returns random number, modifies wyhash64_x
@@ -28,7 +52,7 @@
 
 bool urandom_init()
 {
-    wyhash64_seed(time(NULL) ^ ((uint64_t)getpid() << 32));
+    wyhash64_seed((uint64_t)time(NULL) ^ ((uint64_t)getpid() << 32));
     return true;
 }
 
@@ -61,4 +85,4 @@
     return fclose(randomness);
 }
 
-#endif //MASSRESOLVER_RANDOM_H
+#endif // MASSRESOLVER_RANDOM_H
--- massdns-1.1.0/tests/CMakeLists.txt	1970-01-01 08:00:00.000000000 +0800
+++ massdns-1.1.0/tests/CMakeLists.txt	2025-04-23 21:12:25.120689681 +0800
@@ -0,0 +1,3 @@
+add_executable(test_random test_random.c)
+target_include_directories(test_random PRIVATE ${PROJECT_SOURCE_DIR}/src)
+add_test(NAME RandomTest COMMAND test_random)
--- massdns-1.1.0/tests/test_random.c	1970-01-01 08:00:00.000000000 +0800
+++ massdns-1.1.0/tests/test_random.c	2025-04-23 21:07:44.233164984 +0800
@@ -0,0 +1,21 @@
+#include <stdio.h>
+#include <stdint.h>
+#include <assert.h>
+#include "../src/random.h"
+
+int main() {
+    // 初始化随机种子
+    wyhash64_seed(123456);
+
+    // 获取两个随机数
+    uint64_t a = wyhash64();
+    uint64_t b = wyhash64();
+
+    printf("Random A: %llu\n", (unsigned long long)a);
+    printf("Random B: %llu\n", (unsigned long long)b);
+
+    // 简单断言检查（只要不同即可）
+    assert(a != b);
+
+    return 0; // 表示测试通过
+}
--- massdns-1.1.0/CMakeLists.txt	2024-03-09 08:33:40.000000000 +0800
+++ massdns-1.1.0/CMakeLists.txt	2025-05-10 20:35:44.926576671 +0800
@@ -7,5 +7,22 @@
 
 set(SOURCE_FILES src/main.c src/list.h src/hashmap.h src/massdns.h src/security.h src/net.h src/string.h src/buffers.h src/dns.h
         src/timed_ring.h src/random.h src/cmd.h src/flow.h src/auto_concurrency.h src/tcp.h)
+
 set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
-add_executable(massdns ${SOURCE_FILES})
+
+add_library(massdns_shared SHARED ${SOURCE_FILES})
+
+# Install the shared library
+install(TARGETS massdns_shared
+        LIBRARY DESTINATION lib)
+
+# Install header files
+install(FILES src/list.h src/hashmap.h src/massdns.h src/security.h src/net.h src/string.h src/buffers.h src/dns.h
+        src/timed_ring.h src/random.h src/cmd.h src/flow.h src/auto_concurrency.h src/tcp.h
+        DESTINATION include/massdns)
+
+# Install the executable
+add_executable(massdns src/main.c)
+install(TARGETS massdns RUNTIME DESTINATION bin)
+enable_testing()
+add_subdirectory(tests)
\ 浠跺熬娌℃㈣绗
