# Copyright (c) 2023 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: wangjialun <2271411@stu.neu.edu.cn>, zhangqian<2371418@stu.neu.edu.cn>, wangyihao<2942375747@qq.com> , wangying<wangying@swc.neu.edu.cn>
# Maintainer: wangyihao<2471389@stu.neu.edu.cn>, wangjialun<2271411@stu.neu.edu.cn>, zhangqian<2371418@stu.neu.edu.cn>, wangying<wangying@swc.neu.edu.cn>

source HPKBUILD > /dev/null 2>&1    # 导入HPKBUILD文件
logfile=${LYCIUM_THIRDPARTY_ROOT}/${pkgname}/${pkgname}_${ARCH}_${OHOS_SDK_VER}_test.log

# 测试前的准备, 如果不需要可以不写。
checkprepare(){
    return 0
}

# 在OH环境执行测试的接口
openharmonycheck() {
    res=0                               
    cd ${builddir}/${ARCH}-build
    #ctest批量测试时，exhaustive1_test 和 exhaustive_test 会超时，因此单独执行
    echo "开始测试 exhaustive1_test：" >> ${logfile}
    ./exhaustive1_test >> ${logfile} 2>&1
    if [ $? -ne 0 ]; then
        res=1        
    fi 

    echo "开始测试 exhaustive_test：" >> ${logfile}
    ./exhaustive_test >> ${logfile} 2>&1
    if [ $? -ne 0 ]; then
        res=1
    fi
    
    echo "ctest批量测试，排除已执行的exhaustive1_test和exhaustive_test：" >> ${logfile}  
    #ctest 时忽略上面两个可能会超时的测试用例，只运行其他测试用例
    ctest -E "exhaustive1_test|exhaustive_test" >> ${logfile} 2>&1            
    if [ $? -ne 0 ]; then
        res=1
    fi
    #保存测试失败日志
    if [ $res -ne 0 ]; then
        mkdir -p ${LYCIUM_FAULT_PATH}/${pkgname}
	cp Testing/Temporary/LastTest.log ${LYCIUM_FAULT_PATH}/${pkgname}/test_failed.log
    fi
      
    cd $OLDPWD                          
    return $res                         
}