# Copyright (c) 2023 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: Jeff Han <hanjinfei@foxmail.com>, wen fan <wenfan001@chinasoftinc.com>
# Maintainer: Jeff Han <hanjinfei@foxmail.com>

source HPKBUILD > /dev/null 2>&1
logfile=${LYCIUM_THIRDPARTY_ROOT}/${pkgname}/${pkgname}_${ARCH}_${OHOS_SDK_VER}_test.log

testfile=
separator=

log() {
    echo
    echo "[ $1 ]"
    echo
}

# 开始测试
test() {
    if [[ $# < 1 ]]; then
		log "Wrong number of input parameters: $#"
		return -1
    fi

    if [[ "xno" == "xyes" ]]; then
        testfile="${1//\//\\}"
        separator=\\
    else
        testfile="${1}"
        separator=\/
    fi
    basefile="${testfile##*[/\\]}"
    testfile_md5=
    md5file_markup=
    md5file_rawml=
    shift
    options="$@"
    markup_dir="${basefile%.*}_markup"
    tmp_dir="tmp"
    rawml_file="${basefile%.*}.rawml"
    md5prog="md5sum"
    mobitool=".${separator}libmobi-0.11${separator}${ARCH}-build${separator}tools${separator}mobitool"
    mobidrm=".${separator}libmobi-0.11${separator}${ARCH}-build${separator}tools${separator}mobidrm"
    pid=
    do_md5=1
    is_encrypted=0
    skip=77

	[[ -f "${testfile}" ]] || return -1
    [[ -x "${mobitool}" ]] || return -1

    if [[ "${basefile}" == 'sample-drm'* ]]; then
        [[ "xyes" == "xyes" ]] || return -1
        
        is_encrypted=1
        
        if [[ "${basefile}" == 'sample-drm_pid'* ]]; then
            pid=${basefile:14:10}
            if [[ "${pid}" =~ [^a-zA-Z0-9^] ]]; then
                log "Ignoring incorrect pid ${pid}"
            else
                pid=${pid//^/*}
                options="${options} -p ${pid}"
                log "Using pid ${pid}"
            fi
        fi
    fi

    if [[ -z "${md5prog}" ]]; then
        do_md5=0
        log "Missing md5 tool: ${md5prog}, will skip md5 tests"
    else
        testfile_md5=$(${md5prog} "${testfile//\\/\/}")
        testfile_md5=${testfile_md5%% *}
        md5file_markup="./libmobi-0.11${separator}tests${separator}md5${separator}${testfile_md5}_markup.md5"
        md5file_rawml="./libmobi-0.11${separator}tests${separator}md5${separator}${testfile_md5}_rawml.md5"
    fi

    # create tmp dir
    mkdir -p "${tmp_dir}"

    # recreate source files
    rm -rf "${tmp_dir}/${markup_dir}"
    log "Running ${z} -o \"${tmp_dir}\" -s ${options} \"${testfile}\""
    ${mobitool} -o "${tmp_dir}" -s ${options} "${testfile}" || return -1
    [[ -d "${tmp_dir}${separator}${markup_dir}" ]] || return -1

    # verify checksums
    if [[ "${do_md5}" -eq "1" ]]; then
        if [[ -f "${md5file_markup}" ]]; then
            (
                cd "${tmp_dir}${separator}${markup_dir}" || return -1
                rm -f "..${separator}${testfile_md5}.md5"
                ${md5prog} * > "..${separator}${testfile_md5}.md5"
                diff -w "..${separator}${testfile_md5}.md5" "..${separator}..${separator}${md5file_markup}" || return -1
                rm -f "..${separator}${testfile_md5}.md5"
            ) || return $?
            log "Checksum correct"
        else
            log "No checksums file: ${md5file_markup}, skipping md5 test"
            return -1
        fi
    fi
    rm -rf "${tmp_dir}${separator}${markup_dir}"

    # dump rawml
    rm -f "${tmp_dir}${separator}${rawml_file}"
    log "Running ${mobitool} -o \"${tmp_dir}\" -d ${options} \"${testfile}\""
    ${mobitool} -o "${tmp_dir}" -d ${options} "${testfile}" || return -1
    [[ -f "${tmp_dir}${separator}${rawml_file}" ]] || return -1

    # verify checksum
    if [[ "${do_md5}" -eq "1" ]]; then
        if [[ -f "${md5file_rawml}" ]]; then
            md5_1=$(cat ${md5file_rawml})
            md5_2=$(${md5prog} "${tmp_dir}/${rawml_file}")
            echo "md5_2"${md5_2}
            [[ "${md5_1%% *}" == "${md5_2%% *}" ]] || return -1
            log "Checksum correct"
        else
            log "No checksums file: ${md5file_rawml}, skipping md5 test"
            return -1
        fi
    fi
    rm -f "${tmp_dir}${separator}${rawml_file}"

    # test encryption / decryption
    [[ "xyes" == "xyes" ]] || return -1

    if [[ "${is_encrypted}" -eq "1" ]]; then
        options="-d ${options}"
        verify_options="-s"
        suffix=decrypted
    else
        options="-e -s B001XXXXXXXXXXXX ${options}"
        verify_options="-s -P B001XXXXXXXXXXXX"
        suffix=encrypted
    fi

    drm_file="${basefile%.*}-${suffix}"
    drm_markup="${drm_file}_markup"

    rm -f "${tmp_dir}${separator}${drm_file}."*

    log "Running ${mobidrm} -o \"${tmp_dir}\" ${options} \"${testfile}\""
    output="$(${mobidrm} -o "${tmp_dir}" ${options} "${testfile}" 2>&1)"
    status=$?
    echo "${output}"

    if [[ "${status}" -ne "0" ]]; then
        if [[ "${output}" == *"Can't remove DRM from rented documents"* ]]; then
            log "Exiting with success as rented document should not be processed"
            return 0
        else
			log "DRM operation failed, mobidrm error (${status})"
            return -1
        fi
    fi

    drm_files=()

    [[ -f "${tmp_dir}${separator}${drm_file}.mobi" ]] && drm_files+=("${drm_file}.mobi")
    [[ -f "${tmp_dir}${separator}${drm_file}.azw3" ]] && drm_files+=("${drm_file}.azw3")

    [[ ${#drm_files[@]} -eq 0 ]] && return -1

    # verify
    for drm_file in ${drm_files[@]}; do
        log "Running ${mobitool} -o \"${tmp_dir}\" ${verify_options} \"${tmp_dir}${separator}${drm_file}\""
        ${mobitool} -o "${tmp_dir}" ${verify_options} "${tmp_dir}${separator}${drm_file}" || return -1
        rm -f "${tmp_dir}${separator}${drm_file}"
        rm -rf "${tmp_dir}${separator}${drm_markup}"
    done
	return 0
}

# 循环测试每个文件
start() {
    GREEN="\033[0;32m"
    RED="\033[0;31m"
    NC="\033[0m"

    declare -i all=0
    declare -i fail=0
    declare -i mobiPass=0
    declare -i plamPass=0
    declare -i xfail=0

    samplePath="./libmobi-0.11/tests/samples/"
    echo "" > ${logfile} 2>&1
    for sample in `ls ${samplePath}`
    do
        test ${samplePath}${sample} >> ${logfile} 2>&1
        if [ $? -eq 0 ]
        then
            if [[ "${sample: -5}" == ".mobi" ]]
            then
                echo -e ${GREEN}MOBIPASS ${NC}${sample} >> ${logfile} 2>&1
                mobiPass=${mobiPass}+1
            else
                echo -e ${GREEN}PLAMPASS ${NC}${sample} >> ${logfile} 2>&1
                plamPass=${plamPass}+1
            fi
        else
            if [[ "${sample: -5}" == ".fail" ]]
            then
                echo -e ${GREEN}XFAIL ${NC}${sample} >> ${logfile} 2>&1
                xfail=${xfail}+1
            else
                echo -e ${RED}FAIL ${NC}${sample} >> ${logfile} 2>&1
                fail=${fail}+1
            fi
        fi
        all=${all}+1
    done

    rm -rf tmp

    echo "TOATLLY: "${all} >> ${logfile} 2>&1
    echo -e ${GREEN}"MOBIPASS: "${NC}${mobiPass} >> ${logfile} 2>&1
    echo -e ${GREEN}"PLAMPASS: "${NC}${plamPass} >> ${logfile} 2>&1
    echo -e ${GREEN}"XFAIL: "${NC}${xfail} >> ${logfile} 2>&1
    echo -e ${RED}"FAIL: "${NC}${fail} >> ${logfile} 2>&1

    declare -i full=${mobiPass}+${xfail}+${plamPass}

    if [ ${all} == ${full} ]
    then
        return 0
    else
        return 1
    fi
}

checkprepare(){
    cp -f *.pdb $builddir/tests/samples/
    cp -f *.md5 $builddir/tests/md5/
    return $?
}

openharmonycheck() {
    start
    ret=$?
    return $ret
}
