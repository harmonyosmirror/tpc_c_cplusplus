# Copyright (c) 2023 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: huangminzhong2 <huangminzhong2@huawei.com>
# Maintainer: huangminzhong2 <huangminzhong2@huawei.com>

pkgname=irods
pkgver=4.3.2
pkgrel=0
pkgdesc="iRODS is an open source data management system designed to provide high performance, scalable and secure data storage and access."
url="https://github.com/irods/irods"
archs=("armeabi-v7a" "arm64-v8a")
license=("BSD Licensed")
depends=("avrocpp" "boost" "libzmq" "Catch2" "cppzmq" "fmt-8.1.1" "json" "spdlog" "libarchive" "openssl_1_1_1w" "curl_8_9_0" "nanodbc" "unixODBC" "linux-pam")

makedepends=()
install=
source="https://github.com/$pkgname/$pkgname/archive/refs/tags/$pkgver.tar.gz"

downloadpackage=true
autounpack=true
oneceflag=true
buildtools="cmake"
builddir=$pkgname-${pkgver}
packagename=$builddir.tar.gz

prepare() {
    mkdir -p $builddir/$ARCH-build/irods-externals
    mkdir -p $builddir/$ARCH-build/irods-externals/avro1.11.0-3/lib \
        $builddir/$ARCH-build/irods-externals/avro1.11.0-3/include $builddir/$ARCH-build/irods-externals/avro1.11.0-3/bin \
        $builddir/$ARCH-build/irods-externals/boost1.81.0-1 $builddir/$ARCH-build/irods-externals/catch22.13.8-0 \
        $builddir/$ARCH-build/irods-externals/cppzmq4.8.1-1 $builddir/$ARCH-build/irods-externals/fmt8.1.1-1 $builddir/$ARCH-build/irods-externals/json3.10.4-0 \
        $builddir/$ARCH-build/irods-externals/zeromq4-14.1.8-1  $builddir/$ARCH-build/irods-externals/spdlog1.9.2-2 $builddir/$ARCH-build/irods-externals/nanodbc2.13.0-2 \
        $builddir/$ARCH-build/irods-externals/libarchive3.5.2-0 $builddir/$ARCH-build/irods-externals/impl/impl/json/ \
        $builddir/$ARCH-build/irods-externals/impl/api/ $builddir/$ARCH-build/irods-externals/clang13.0.1-0

    ln -s ${LYCIUM_ROOT}/usr/avrocpp/${ARCH}/include/* $builddir/$ARCH-build/irods-externals/avro1.11.0-3/include
    ln -s ${LYCIUM_ROOT}/usr/avrocpp/${ARCH}/lib/* $builddir/$ARCH-build/irods-externals/avro1.11.0-3/lib
    ln -s ${LYCIUM_ROOT}/../thirdparty/avrocpp/avro-release-1.11.1/host-build/avrogencpp $builddir/$ARCH-build/irods-externals/avro1.11.0-3/bin/avrogencpp
    ln -s ${LYCIUM_ROOT}/usr/boost/${ARCH}/* $builddir/$ARCH-build/irods-externals/boost1.81.0-1
    ln -s ${LYCIUM_ROOT}/usr/Catch2/${ARCH}/* $builddir/$ARCH-build/irods-externals/catch22.13.8-0
    ln -s ${LYCIUM_ROOT}/usr/cppzmq/${ARCH}/* $builddir/$ARCH-build/irods-externals/cppzmq4.8.1-1
    ln -s ${LYCIUM_ROOT}/usr/fmt-8.1.1/${ARCH}/* $builddir/$ARCH-build/irods-externals/fmt8.1.1-1
    ln -s ${LYCIUM_ROOT}/usr/json/${ARCH}/* $builddir/$ARCH-build/irods-externals/json3.10.4-0
    ln -s ${LYCIUM_ROOT}/usr/libzmq/${ARCH}/* $builddir/$ARCH-build/irods-externals/zeromq4-14.1.8-1
    ln -s ${LYCIUM_ROOT}/usr/spdlog/${ARCH}/* $builddir/$ARCH-build/irods-externals/spdlog1.9.2-2
    ln -s ${LYCIUM_ROOT}/usr/nanodbc/${ARCH}/* $builddir/$ARCH-build/irods-externals/nanodbc2.13.0-2
    ln -s ${LYCIUM_ROOT}/usr/libarchive/${ARCH}/* $builddir/$ARCH-build/irods-externals/libarchive3.5.2-0
    ln -s ${LYCIUM_ROOT}/../thirdparty/avrocpp/avro-release-1.11.1/lang/c++/impl/json/*  $builddir/$ARCH-build/irods-externals/impl/impl/json/
    ln -s ${LYCIUM_ROOT}/../thirdparty/avrocpp/avro-release-1.11.1/lang/c++/api/*  $builddir/$ARCH-build/irods-externals/impl/api/

    if $onceflag
    then
        cd $builddir
        # 打patch处理交叉编译问题、版本号IDE不支持问题
        patch -p1 < `pwd`/../irods_oh_pkg.patch >> $publicbuildlog 2>&1
        # 修改依赖boost库为.a依赖
        grep -rl "/lib/libboost" ./ | xargs -I {}  sed -i 's|\(/lib/libboost_[^.]*\)\.so$|\1.a|g' {}
        grep -rl "/lib/libboost" ./ | xargs -I {}  sed -i 's|\(/lib/libboost_[^.]*\)\.so"$|\1.a"|g' {}
        grep -rl "/lib/libboost" ./ | xargs -I {}  sed -i 's|\(/lib/libboost_[^.]*\)\.so)$|\1.a)|g' {}

        onceflag=false
        cd $OLDPWD
    fi
}

build() {
    cd $builddir
    PKG_CONFIG_LIBDIR="${pkgconfigpath}" ${OHOS_SDK}/native/build-tools/cmake/bin/cmake "$@" \
        -DCURL_LIBRARY="${LYCIUM_ROOT}/usr/curl/$ARCH"   \
        -DIRODS_EXTERNALS_PACKAGE_ROOT=`pwd`/$ARCH-build/irods-externals \
        -DOHOS_ARCH=$ARCH -DIRODS_BUILD_AGAINST_LIBCXX=OFF \
        -DIRODS_DISABLE_COMPILER_OPTIMIZATIONS=ON -DIRODS_UNIT_TESTS_BUILD=ON \
        -Dfmt_DIR=${LYCIUM_ROOT}/usr/linux-pam/$ARCH/include \
        -DCMAKE_CXX_FLAGS="-I${LYCIUM_ROOT}/../thirdparty/linux-pam/linux-pam-8562cb1b951e7bd807af6b43d85c71cedd7b10d7-${ARCH}-build/libpam/include \
        -I${LYCIUM_ROOT}/usr/openssl_1_1_1w/$ARCH/include \
        -I${LYCIUM_ROOT}/usr/curl_8_9_0/$ARCH/include \
        -I${LYCIUM_ROOT}/usr/unixODBC/$ARCH/include \
        -I`pwd`/flex/ -I`pwd`/gssapi/ \
        -I`pwd`/$ARCH-build/irods-externals/impl/impl \
        -I`pwd`/$ARCH-build/irods-externals/impl/api/ \
        -UIRODS_ENABLE_SYSLOG \
        -DIRODS_BUILD_WITH_WERROR=OFF \
        -Wno-c++11-narrowing \
        -Wunused-command-line-argument \
        -Wno-error=unused-command-line-argument" -B$ARCH-build -S./ -L >  $buildlog 2>&1
    
    $MAKE VERBOSE=1 -C $ARCH-build >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

package() {
    cd $builddir
    make -C $ARCH-build install >>  $buildlog 2>&1
    cd $OLDPWD
}

check() {
    echo "The test must be on an OpenHarmony device!"
    cd $builddir/$ARCH-build
    # 屏蔽用例（依赖服务器环境，手动执行）
    patterns_to_delete=(  
        "file_object"  
        "replica_access_table"  
        "replica_state_table"  
        "atomic_apply_acl_operations"  
        "atomic_apply_metadata_operations"  
        "client_connection"  
        "connection_pool"  
        "data_object_finalize"  
        "data_object_modify_info"
        "dstream"
        "filesystem"
        "get_delay_rule_info"
        "get_file_descriptor_info"
        "get_resource_info_for_operation"
        "json_apis_from_client"
        "logical_locking"
        "logical_paths_and_special_characters"
        "metadata"
        "parallel_transfer_engine"
        "query_builder"
        "rcTicketAdmin"
        "rc_check_auth_credentials"
        "rc_data_obj"
        "rc_genquery2"
        "rc_get_library_features"
        "rc_mod_data_obj_meta"
        "rc_switch_user"
        "replica"
        "replica_open_and_close"
        "replica_truncate"
        "resource_administration"
        "ticket_administration"
        "user_administration"
        "zone_administration"
        "zone_report"
    )
    
    # 循环遍历数组并执行sed命令
    cp unit_tests/CTestTestfile.cmake unit_tests/CTestTestfile.cmake.bak
    for pattern in "${patterns_to_delete[@]}"; do
        sed -i "/${pattern}\"/{N;d;}" unit_tests/CTestTestfile.cmake
    done
    ret=$?
    cd $OLDPWD
    return $ret
}

cleanbuild() {
    rm -rf ${PWD}/$builddir
}
