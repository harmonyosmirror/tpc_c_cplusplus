# Copyright (c) 2022 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import("//build/ohos.gni")

declare_args() {
  enable_openjpeg_test = false
}

config("tiff_cflag_config") {
  cflags = [
    "-Wno-unused-function",
    "-D_FILE_OFFSET_BITS=64",
    "-Wno-format",
    "-Wno-misleading-indentation",
  ]
}

ohos_static_library("tiff") {
  sources = [
    "openjpeg/thirdparty/libtiff/tif_aux.c",
    "openjpeg/thirdparty/libtiff/tif_close.c",
    "openjpeg/thirdparty/libtiff/tif_codec.c",
    "openjpeg/thirdparty/libtiff/tif_color.c",
    "openjpeg/thirdparty/libtiff/tif_compress.c",
    "openjpeg/thirdparty/libtiff/tif_dir.c",
    "openjpeg/thirdparty/libtiff/tif_dirinfo.c",
    "openjpeg/thirdparty/libtiff/tif_dirread.c",
    "openjpeg/thirdparty/libtiff/tif_dirwrite.c",
    "openjpeg/thirdparty/libtiff/tif_dumpmode.c",
    "openjpeg/thirdparty/libtiff/tif_error.c",
    "openjpeg/thirdparty/libtiff/tif_extension.c",
    "openjpeg/thirdparty/libtiff/tif_fax3.c",
    "openjpeg/thirdparty/libtiff/tif_fax3sm.c",
    "openjpeg/thirdparty/libtiff/tif_flush.c",
    "openjpeg/thirdparty/libtiff/tif_getimage.c",
    "openjpeg/thirdparty/libtiff/tif_jbig.c",
    "openjpeg/thirdparty/libtiff/tif_jpeg.c",
    "openjpeg/thirdparty/libtiff/tif_jpeg_12.c",
    "openjpeg/thirdparty/libtiff/tif_luv.c",
    "openjpeg/thirdparty/libtiff/tif_lzma.c",
    "openjpeg/thirdparty/libtiff/tif_lzw.c",
    "openjpeg/thirdparty/libtiff/tif_next.c",
    "openjpeg/thirdparty/libtiff/tif_ojpeg.c",
    "openjpeg/thirdparty/libtiff/tif_open.c",
    "openjpeg/thirdparty/libtiff/tif_packbits.c",
    "openjpeg/thirdparty/libtiff/tif_pixarlog.c",
    "openjpeg/thirdparty/libtiff/tif_predict.c",
    "openjpeg/thirdparty/libtiff/tif_print.c",
    "openjpeg/thirdparty/libtiff/tif_read.c",
    "openjpeg/thirdparty/libtiff/tif_strip.c",
    "openjpeg/thirdparty/libtiff/tif_swab.c",
    "openjpeg/thirdparty/libtiff/tif_thunder.c",
    "openjpeg/thirdparty/libtiff/tif_tile.c",
    "openjpeg/thirdparty/libtiff/tif_unix.c",
    "openjpeg/thirdparty/libtiff/tif_version.c",
    "openjpeg/thirdparty/libtiff/tif_warning.c",
    "openjpeg/thirdparty/libtiff/tif_write.c",
    "openjpeg/thirdparty/libtiff/tif_zip.c",
  ]
  include_dirs = [
    "./openjpeg/thirdparty/libtiff",
    "./adapter/include/tiff",
  ]
  configs = [ ":tiff_cflag_config" ]
}

config("lcms2_cflag_config") {
  cflags = [ "-Wno-unused-function" ]
}

ohos_static_library("lcms2") {
  sources = [
    "./openjpeg/thirdparty/liblcms2/src/cmsalpha.c",
    "./openjpeg/thirdparty/liblcms2/src/cmscam02.c",
    "./openjpeg/thirdparty/liblcms2/src/cmscgats.c",
    "./openjpeg/thirdparty/liblcms2/src/cmscnvrt.c",
    "./openjpeg/thirdparty/liblcms2/src/cmserr.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsgamma.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsgmt.c",
    "./openjpeg/thirdparty/liblcms2/src/cmshalf.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsintrp.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsio0.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsio1.c",
    "./openjpeg/thirdparty/liblcms2/src/cmslut.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsmd5.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsmtrx.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsnamed.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsopt.c",
    "./openjpeg/thirdparty/liblcms2/src/cmspack.c",
    "./openjpeg/thirdparty/liblcms2/src/cmspcs.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsplugin.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsps2.c",
    "./openjpeg/thirdparty/liblcms2/src/cmssamp.c",
    "./openjpeg/thirdparty/liblcms2/src/cmssm.c",
    "./openjpeg/thirdparty/liblcms2/src/cmstypes.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsvirt.c",
    "./openjpeg/thirdparty/liblcms2/src/cmswtpnt.c",
    "./openjpeg/thirdparty/liblcms2/src/cmsxform.c",
  ]
  include_dirs = [
    "./openjpeg/thirdparty/liblcms2/include",
    "./openjpeg/thirdparty/liblcms2/src",
  ]
  configs = [ ":lcms2_cflag_config" ]
}

config("openjpeg_cflag_config") {
  cflags = [
    "-Wno-unused-function",
    "-Wno-declaration-after-statement",
    "-DMUTEX_pthread",
    "-Dopenjp2_EXPORTS",
  ]
}

ohos_shared_library("openjp2") {
  sources = [
    "./openjpeg/src/lib/openjp2/bio.c",
    "./openjpeg/src/lib/openjp2/cio.c",
    "./openjpeg/src/lib/openjp2/dwt.c",
    "./openjpeg/src/lib/openjp2/event.c",
    "./openjpeg/src/lib/openjp2/function_list.c",
    "./openjpeg/src/lib/openjp2/ht_dec.c",
    "./openjpeg/src/lib/openjp2/image.c",
    "./openjpeg/src/lib/openjp2/invert.c",
    "./openjpeg/src/lib/openjp2/j2k.c",
    "./openjpeg/src/lib/openjp2/jp2.c",
    "./openjpeg/src/lib/openjp2/mct.c",
    "./openjpeg/src/lib/openjp2/mqc.c",
    "./openjpeg/src/lib/openjp2/openjpeg.c",
    "./openjpeg/src/lib/openjp2/opj_clock.c",
    "./openjpeg/src/lib/openjp2/opj_malloc.c",
    "./openjpeg/src/lib/openjp2/pi.c",
    "./openjpeg/src/lib/openjp2/sparse_array.c",
    "./openjpeg/src/lib/openjp2/t1.c",
    "./openjpeg/src/lib/openjp2/t2.c",
    "./openjpeg/src/lib/openjp2/tcd.c",
    "./openjpeg/src/lib/openjp2/tgt.c",
    "./openjpeg/src/lib/openjp2/thread.c",
  ]

  include_dirs = [
    "./openjpeg/src/lib/openjp2",
    "./adapter/include",
    "./adapter/include/tiff",
    "./openjpeg/thirdparty/liblcms2/include",
  ]

  configs = [ ":openjpeg_cflag_config" ]

  part_name = "openjpeg"
}

config("openjpeg_test_config") {
  cflags = [
    "-Wno-macro-redefined",
    "-Wno-unused-variable",
    "-DOPJ_HAVE_LIBLCMS2",
    "-DOPJ_HAVE_LCMS2_H",
    "-DOPJ_HAVE_TIFF_H",
    "-DOPJ_HAVE_LIBTIFF",
  ]
  include_dirs = [
    "./openjpeg/src/lib/openjp2",
    "./openjpeg/src/bin/common",
    "./openjpeg/src/lib/jp2",
    "./openjpeg/src/bin/jp2",
    "./adapter/include",
    "./adapter/include/tiff",
    "./openjpeg/thirdparty/libtiff",
  ]
}

ohos_executable("test_tile_decoder") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/test_tile_decoder.c",
  ]
  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("test_tile_encoder") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/test_tile_encoder.c",
  ]
  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("compare_dump_files") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/compare_dump_files.c",
  ]
  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("compare_images") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/src/bin/jp2/convert.c",
    "./openjpeg/src/bin/jp2/converttif.c",
    "./openjpeg/tests/compare_images.c",
  ]
  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("compare_raw_files") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/compare_raw_files.c",
  ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("j2k_random_tile_access") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/j2k_random_tile_access.c",
  ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("pdf2jp2") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/pdf2jp2.c",
  ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("test_decode_area") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/test_decode_area.c",
  ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("ppm2rgb3") {
  sources = [
    "./openjpeg/src/bin/common/opj_getopt.c",
    "./openjpeg/tests/ppm2rgb3.c",
  ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [
    ":lcms2",
    ":openjp2",
    ":tiff",
  ]
  part_name = "openjpeg"
}

ohos_executable("testempty0") {
  sources = [ "./openjpeg/tests/unit/testempty0.c" ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [ ":openjp2" ]
  part_name = "openjpeg"
}

ohos_executable("testempty1") {
  sources = [ "./openjpeg/tests/unit/testempty1.c" ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [ ":openjp2" ]
  part_name = "openjpeg"
}

ohos_executable("testempty2") {
  sources = [ "./openjpeg/tests/unit/testempty2.c" ]

  public_configs = [ ":openjpeg_test_config" ]
  deps = [ ":openjp2" ]
  part_name = "openjpeg"
}

group("openjpeg") {
  deps = [ ":openjp2" ]
  if (enable_openjpeg_test) {
    deps += [
      ":compare_dump_files",
      ":compare_images",
      ":compare_raw_files",
      ":j2k_random_tile_access",
      ":pdf2jp2",
      ":ppm2rgb3",
      ":test_decode_area",
      ":test_tile_decoder",
      ":test_tile_encoder",
      ":testempty0",
      ":testempty1",
      ":testempty2",
    ]
  }
}
